generator client {
  provider = "prisma-client"
  output   = "../src/shared/database/generated/prisma"
}

datasource db {
  provider = "postgresql"
}
enum Sexo {
  MASCULINO
  FEMININO
}

enum StatusPagamento {
  PENDENTE
  PAGO
}

model Usuario {
  id_usuario     String         @id @default(uuid())
  email          String         @unique @db.VarChar(200)
  senha_hash     String         @db.VarChar(200)
  tipo_usuario   String         @db.VarChar(50)
  ativo          Boolean        @default(true)
  paciente       Paciente?
  profissional   Profissional?
  refresh_tokens RefreshToken[]
  
  logs Log[]

  @@map("usuarios")
}

model Paciente {
  id_paciente     String   @id @default(uuid())
  nome            String   @db.VarChar(200)
  sexo            Sexo     // Novo campo solicitado
  cpf             String   @unique @db.VarChar(14)
  data_nascimento DateTime @db.Date
  id_usuario      String   @unique
  id_endereco     String?  // Opcional se criar endereço depois, ou obrigatório na transaction

  usuario  Usuario   @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
  endereco Endereco? @relation(fields: [id_endereco], references: [id_endereco])

  telefones   PacienteTelefone[]
  tags        PacienteTag[]
  debitos     PacienteDebito[]
  prontuarios Prontuario[]
  agendamentos Agendamento[]

  @@map("pacientes")
}

model PacienteTelefone {
  id_telefone String  @id @default(uuid())
  telefone    String  @db.VarChar(20)
  principal   Boolean @default(false)
  id_paciente String
  
  paciente    Paciente @relation(fields: [id_paciente], references: [id_paciente], onDelete: Cascade)

  @@map("paciente_telefones")
}

model PacienteTag {
  id_tag      String @id @default(uuid())
  nome        String @db.VarChar(50)
  id_paciente String

  paciente Paciente @relation(fields: [id_paciente], references: [id_paciente], onDelete: Cascade)

  @@map("paciente_tags")
}

model PacienteDebito {
  id_debito        String          @id @default(uuid())
  id_paciente      String
  id_agendamento   String?         // Opcional caso não venha de um agendamento direto
  valor_total      Float
  valor_pago       Float           @default(0)
  status_pagamento StatusPagamento
  data_vencimento  DateTime        @db.Date
  observacoes      String?         @db.Text

  paciente Paciente @relation(fields: [id_paciente], references: [id_paciente], onDelete: Cascade)

  @@map("paciente_debitos")
}



model Profissional {
  id_profissional   String @id @default(uuid())
  nome              String @db.VarChar(200)
  cpf               String @unique @db.VarChar(11)
  registro_conselho String @db.VarChar(50)
  id_usuario        String @unique

  // Relações
  usuario        Usuario                      @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
  horarios       Horario_Trabalho[]
  telefones      Profissional_telefone[]
  especialidades Profissional_Especialidade[]
  servicos       ProfissionalServico[]
  prontuarios    ProntuarioEntrada[]
  agendamentos Agendamento[]

  @@map("profissionais")
}


model Horario_Trabalho {
  id_horario      String   @id @default(uuid())
  dia_semana      Int
  hora_inicio     DateTime @db.Time
  hora_fim        DateTime @db.Time
  id_profissional String

  profissional Profissional @relation(fields: [id_profissional], references: [id_profissional], onDelete: Cascade)

  @@map("horarios_trabalho")
}

model Profissional_telefone {
  id_telefone     String  @id @default(uuid())
  telefone        String  @db.VarChar(11)
  principal       Boolean @default(false)
  id_profissional String

  profissional Profissional @relation(fields: [id_profissional], references: [id_profissional], onDelete: Cascade)

  @@map("profissional_telefones")
}

model Profissional_Especialidade {
  id_profissional  String
  id_especialidade String

  profissional  Profissional  @relation(fields: [id_profissional], references: [id_profissional], onDelete: Cascade)
  especialidade Especialidade @relation(fields: [id_especialidade], references: [id_especialidade], onDelete: Cascade)

  @@id([id_profissional, id_especialidade])
  @@map("profissionais_especialidades")
}

model Endereco {
  id_endereco String     @id @default(uuid())
  rua         String
  numero      String?
  cidade      String
  estado      String
  pacientes   Paciente[]

  @@map("enderecos")
}

model Servico {
  id_servico             String  @id @default(uuid())
  nome                   String  @db.VarChar(200)
  duracao_estimada       Int
  descricao              String  @db.Text
  preco                  Float
  ativo                  Boolean @default(true)
  preco_visivel_paciente Boolean @default(true)

  profissionais ProfissionalServico[]
  agendamentos AgendamentoServico[]

  @@map("servicos")
}

model Especialidade {
  id_especialidade String  @id @default(uuid())
  nome             String  @unique @db.VarChar(200)
  descricao        String? @db.Text

  profissionais Profissional_Especialidade[]

  @@map("especialidades")
}

model ProfissionalServico {
  id_profissional String
  id_servico      String

  profissional Profissional @relation(fields: [id_profissional], references: [id_profissional], onDelete: Cascade)
  servico      Servico      @relation(fields: [id_servico], references: [id_servico], onDelete: Cascade)

  @@id([id_profissional, id_servico])
  @@map("profissional_servico")
}

model RefreshToken {
  id_refresh_token String    @id @default(uuid())
  token            String    @unique @db.VarChar(255)
  expiracao        DateTime  @db.Timestamp(6)
  criado_em        DateTime? @default(now()) @db.Timestamp(6)
  ativo            Boolean?  @default(true)
  id_usuario       String

  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)

  @@map("refresh_tokens")
}



enum TipoEntradaProntuario {
  ANAMNESE
  PLANO_TRATAMENTO
  EVOLUCAO_VISITA
  DIAGNOSTICO
  OBSERVACAO_GERAL
}

enum TipoArquivoProntuario {
  RADIOGRAFIA
  FOTO
  CONSENTIMENTO
  RECEITA
  ATESTADO
  EXAME_EXTERNO
  OUTRO
}


model Prontuario {
  id_prontuario String   @id @default(uuid())
  id_paciente   String
  criado_em     DateTime @default(now())

  paciente Paciente @relation(fields: [id_paciente], references: [id_paciente], onDelete: Cascade)
  entradas ProntuarioEntrada[]

  @@map("prontuarios")
}

model ProntuarioEntrada {
  id_entrada      String                 @id @default(uuid())
  id_prontuario   String
  id_profissional String?
  id_agendamento  String?
  tipo            TipoEntradaProntuario
  descricao       String                 @db.Text
  criado_em       DateTime               @default(now())
  atualizado_em   DateTime               @updatedAt

  prontuario   Prontuario   @relation(fields: [id_prontuario], references: [id_prontuario], onDelete: Cascade)
  profissional Profissional? @relation(fields: [id_profissional], references: [id_profissional])
  arquivos     ProntuarioArquivo[]

  @@map("prontuarios_entradas")
}

model ProntuarioArquivo {
  id_arquivo     String                @id @default(uuid())
  id_entrada     String
  nome_arquivo   String                @db.VarChar(200)
  url_arquivo    String                @db.VarChar(500)
  tipo_arquivo   String                @db.VarChar(50) // mime/extensão
  tipo_documento TipoArquivoProntuario
  descricao      String?               @db.Text
  data_upload    DateTime              @default(now())

  entrada ProntuarioEntrada @relation(fields: [id_entrada], references: [id_entrada], onDelete: Cascade)

  @@map("prontuarios_arquivos")
}

model Log {
  id         String   @id @default(uuid())
  tipo       String   @db.VarChar(30)
  acao       String   @db.VarChar(100)
  descricao  String?
  ip         String?
  user_agent String?
  sucesso    Boolean
  data       DateTime @default(now())
  dados      Json?
  id_usuario String?
  usuario    Usuario? @relation(fields: [id_usuario], references: [id_usuario], onDelete: SetNull)

  @@map("logs")
}

// Adicione ao seu schema.prisma

enum StatusAgendamento {
  CONFIRMADO
  PENDENTE
  CANCELADO
  CONCLUIDO
  NAO_COMPARECEU
}

model Agendamento {
  id_agendamento   String            @id @default(uuid())
  id_paciente      String
  id_profissional  String
  data_hora_inicio DateTime          @db.Timestamp
  data_hora_fim    DateTime          @db.Timestamp
  status           StatusAgendamento @default(PENDENTE)
  observacoes      String?           @db.Text
  criado_em        DateTime          @default(now())
  atualizado_em    DateTime          @updatedAt

  paciente     Paciente              @relation(fields: [id_paciente], references: [id_paciente], onDelete: Cascade)
  profissional Profissional          @relation(fields: [id_profissional], references: [id_profissional], onDelete: Cascade)
  servicos     AgendamentoServico[]

  @@map("agendamentos")
}

model AgendamentoServico {
  id_agendamento String
  id_servico     String
  ordem          Int     @default(0) // Ordem de execução dos serviços
  preco_cobrado  Float   // Preço no momento do agendamento (pode ser diferente do atual)
  observacao     String? @db.Text

  agendamento Agendamento @relation(fields: [id_agendamento], references: [id_agendamento], onDelete: Cascade)
  servico     Servico     @relation(fields: [id_servico], references: [id_servico], onDelete: Restrict)

  @@id([id_agendamento, id_servico])
  @@map("agendamento_servicos")
}
